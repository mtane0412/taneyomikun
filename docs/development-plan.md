# 音声読み上げデスクトップアプリケーション開発計画

## プロジェクト概要
棒読みちゃんのような音声読み上げデスクトップアプリケーションをTauri v2とCartesia TTS APIを使用して開発します。

## 技術スタック
- **フロントエンド**: Vite + React/Vue/Svelte（選定予定）+ TypeScript
- **バックエンド**: Tauri v2 (Rust)
- **音声合成**: Cartesia TTS API (WebSocket接続)
- **スタイリング**: Tailwind CSS または CSS Modules

## 開発フェーズ

### フェーズ1: 基盤構築（優先度: 高）✅ 完了

#### 1. プロジェクトセットアップ ✅ 完了 (2025-08-06)
- ✅ Tauri + Vite環境の構築
  - Tauri v2 + React + TypeScript環境をセットアップ
  - Vite設定ファイル作成（vite.config.ts）
  - package.jsonにスクリプト追加
- ✅ TypeScript設定
  - tsconfig.json作成（React + Tauri用）
  - tsconfig.node.json作成（Vite用）
  - 型定義パッケージインストール済み
- ✅ ESLint/Prettier設定
  - ESLint v9形式の設定ファイル作成（eslint.config.js）
  - Prettier設定ファイル作成（.prettierrc）
  - lint/formatスクリプト追加
- ✅ 基本的なプロジェクト構造の確立
  - src/ディレクトリ構造作成（components, hooks, stores, utils）
  - src-tauri/ディレクトリ構造作成（commands, tts, config）
  - 基本的なReactアプリケーション作成（App.tsx, main.tsx）
  - Rustプロジェクト初期化（Cargo.toml, main.rs, lib.rs）

#### 2. 基本的なUIデザインと実装 ✅ 完了 (2025-08-07)
- **メインウィンドウ** ✅
  - ✅ テキスト入力エリア（複数行対応）
  - ✅ 読み上げ開始/停止ボタン
  - ✅ 音量インジケーター
- **設定パネル** ✅
  - ✅ API キー入力フィールド
  - ✅ 音声選択ドロップダウン
  - ✅ 速度・音量スライダー

#### 3. Cartesia TTS API統合 ✅ 完了 (2025-08-07)
- ✅ Rust側でのAPI通信モジュール実装
  - TTSモジュール構造作成（client, config, error）
  - CartesiaClientの実装（WebSocket接続対応）
  - エラー型定義（TTSError, TTSResult）
- ✅ APIキーの安全な保存（keyringクレート使用）
  - ApiKeyManagerの実装
  - セキュアなAPIキー保存・取得・削除機能
- ✅ エラーハンドリング（ネットワークエラー、APIエラー）
  - 各種エラーケースの網羅的な実装
  - 日本語エラーメッセージ対応
- ✅ Tauriコマンドの実装
  - set_api_key, check_api_key, remove_api_key
  - update_tts_config, get_tts_config, synthesize_speech
- ✅ フロントエンドTTSユーティリティ実装

#### 4. 音声再生機能の実装 ✅ 完了 (2025-08-07)
- ✅ WebSocketでのストリーミング音声受信
  - Cartesia APIからのWebSocket経由での音声データ受信実装
  - Base64エンコード/デコード処理実装
- ✅ 音声バッファリング管理
  - Web Audio APIを使用したストリーミング再生実装
  - AudioBufferを使用したキューイングシステム実装
- ✅ 再生制御（開始、停止、一時停止）
  - play/pause/stop機能の実装
  - フロントエンドからの制御UI実装

### フェーズ2: 機能拡張（優先度: 中）

#### 5. 音声設定機能 ✅ 完了 (2025-08-07)
- ~~複数の音声プロファイル管理~~ (シンプル化のため削除)
- ~~日本語音声の最適化~~ (Tanenobu音声固定)
- ✅ 読み上げ速度の細かな調整（0.5x - 2.0x）
- ✅ 音量の記憶と自動適用

#### 6. 読み上げキューシステム ✅ 完了 (2025-08-07)
- ✅ 複数テキストのキューイング
- ✅ キュー表示UI
- ✅ 優先度付きキュー機能（高/中/低）
- ✅ キューの保存と読み込み（localStorage使用）
- ✅ 自動連続再生機能
- ✅ テスト実装（TDD）

#### 7. HTTPサーバー機能 ✅ 完了 (2025-08-07)
- ✅ HTTPサーバーの実装（axum使用）
- ✅ /tts エンドポイント（POST）での文字列受信
- ✅ /health エンドポイント（GET）でのヘルスチェック
- ✅ ポート設定機能（デフォルト: 50080）
- ✅ 設定UIでのHTTPサーバー有効/無効切り替え
- ✅ 外部アプリケーションからの読み上げリクエスト対応
- ✅ 優先度付きキューイング対応（high/normal/low）

#### 8. システムトレイ対応
- 最小化時のトレイ常駐
- トレイメニューからの主要機能アクセス
- 通知機能（読み上げ開始/完了）

### フェーズ3: 応用機能（優先度: 低）

#### 9. ホットキー機能
- グローバルショートカットの設定
- カスタマイズ可能なキーバインディング
- クリップボード監視と自動読み上げオプション

#### 10. 読み上げ履歴機能
- 読み上げたテキストの履歴保存
- 履歴の検索・フィルタリング
- 履歴からの再読み上げ

### フェーズ4: 品質保証（優先度: 高）

#### 11. テスト実装とエラーハンドリング
- ユニットテスト（Rust側とフロントエンド側）
- 統合テスト
- エラー処理の強化
- ユーザーフレンドリーなエラーメッセージ

## アーキテクチャ設計

### ディレクトリ構造
```
Taneyomi-kun/
├── src/                    # フロントエンドソース
│   ├── components/         # UIコンポーネント
│   ├── hooks/             # カスタムフック
│   ├── stores/            # 状態管理
│   ├── utils/             # ユーティリティ関数
│   └── main.ts
├── src-tauri/             # Rustバックエンド
│   ├── src/
│   │   ├── commands/      # Tauriコマンド
│   │   ├── tts/          # TTS関連モジュール
│   │   ├── config/       # 設定管理
│   │   └── main.rs
│   └── tauri.conf.json
├── tests/                 # テストファイル
└── docs/                  # ドキュメント
```

### データフロー
1. ユーザーがテキストを入力
2. フロントエンドからTauriコマンドを呼び出し
3. RustバックエンドがCartesia APIにWebSocket接続
4. ストリーミングで音声データを受信
5. 音声をバッファリングして再生
6. 再生状態をフロントエンドに通知

## 技術的な考慮事項

### パフォーマンス
- WebSocketの接続を事前に確立して遅延を最小化
- 音声バッファリングで途切れない再生を実現
- メモリ使用量の最適化

### セキュリティ
- APIキーの暗号化保存
- Content Security Policy (CSP) の適切な設定
- 外部通信の最小化

### ユーザビリティ
- 直感的なUI/UX
- キーボードショートカット対応
- アクセシビリティ対応（スクリーンリーダー互換性）

## 開発スケジュール目安

- **週1-2**: フェーズ1完了（基本機能の実装）✅ 2025-08-06 完了
- **週3-4**: フェーズ2完了（機能拡張）
- **週5**: フェーズ3完了（応用機能）
- **週6**: フェーズ4完了（品質保証とリリース準備）

## 進捗ログ

### 2025-08-07 (後半その3)
- HTTPサーバー機能の実装を完了
  - axumを使用したHTTPサーバーの実装
  - /tts エンドポイント（POST）での文字列受信機能
  - /health エンドポイント（GET）でのヘルスチェック機能
  - ポート設定機能の実装（デフォルト: 50080）
  - 設定UIにHTTPサーバー設定セクションを追加
  - HTTPサーバーの有効/無効切り替え機能
  - 外部アプリケーションからのリクエスト処理
  - 優先度付きキューイングとの統合
  - テスト用スクリプト（test-http.sh）の作成

### 2025-08-07 (後半その2)
- 読み上げキューシステムの実装を完了
  - QueueStoreクラスの実装（優先度管理、ステータス管理）
  - QueuePanelコンポーネントの実装（UI）
  - useQueueStoreカスタムフックの実装
  - キューの永続化（localStorage使用）
  - 自動連続再生機能（キューアイテムの順次処理）
  - テスト駆動開発（TDD）での実装
  - Vitest環境のセットアップ
  - すべてのテストがパス（20/20）

### 2025-08-07 (完了)
- 音声プロファイル管理機能の実装と削除
  - 複数の音声プロファイル管理機能を実装
  - モデル選択方式（sonic-2）への変更
  - Cartesia API仕様に合わせた実装（model_id, voice）
  - その後、要件変更により音声選択とプロファイル機能を削除
  - Tanenobu音声（fb25b315-dfba-444f-b99d-4c8535672cb7）に固定
- フェーズ2の一部機能を実装後、シンプル化のため削除
  - 最終的にAPIキー設定、速度調整、音量調整のみを残す

### 2025-08-07 (後半)
- 音声再生機能の実装を完了
  - Web Audio APIを使用したストリーミング音声再生実装
  - AudioPlayerクラスの作成（PCM f32le形式対応）
  - Tauriイベントシステムによるフロントエンド・バックエンド間通信
  - 再生制御機能（play/pause/stop）の実装
  - macOSでのrodioクレート互換性問題を回避（Web Audio API採用）

### 2025-08-07 (前半)
- Cartesia TTS API統合を完了
  - TTSモジュール実装（client.rs, config.rs, error.rs）
  - APIキーの安全な保存機能（keyringクレート使用）
  - Tauriコマンド実装（6個のコマンド）
  - フロントエンドTTSユーティリティ実装
  - App.tsxのAPI統合対応
- 基本的なUIデザインと実装を完了
  - メインウィンドウ（テキスト入力、読み上げボタン、音量インジケーター）
  - 設定パネル（APIキー入力、音声選択、速度調整）
  - レスポンシブなUIコンポーネント
  - アプリケーションアイコンの作成と設定
  - Rustコンパイルエラーの修正

### 2025-08-06
- フェーズ1を完了
- Tauri v2 + React + TypeScript環境のセットアップ完了
- プロジェクト構造の確立
- ESLint/Prettier設定完了
- 基本的なReactアプリケーション（Taneyomi-kun）のUIを作成

## リリース計画

### v1.0.0 (MVP)
- 基本的な読み上げ機能
- 音声設定
- システムトレイ対応

### v1.1.0
- ホットキー機能
- 読み上げキュー
- 履歴機能

### v2.0.0
- プラグインシステム
- カスタム辞書機能
- 多言語対応の強化